import { Client, LocalAuth, MessageMedia } from 'whatsapp-web.js';
import qrcode from 'qrcode-terminal';
import { saveMessage, saveSchedule, getContacts } from './database.js';
import { generateResponse } from './geminiService.js';

class WhatsAppService {
  constructor() {
    this.client = null;
    this.isConnected = false;
    this.userStates = new Map();
    this.userData = new Map();
    this.onQRCode = null;
    this.onReady = null;
    this.onMessage = null;
  }

  initialize() {
    this.client = new Client({
      authStrategy: new LocalAuth({
        clientId: "whatsapp-bot-business"
      }),
      puppeteer: {
        headless: true,
        args: [
          '--no-sandbox',
          '--disable-setuid-sandbox',
          '--disable-dev-shm-usage',
          '--disable-accelerated-2d-canvas',
          '--no-first-run',
          '--no-zygote',
          '--disable-gpu'
        ]
      },
      webVersionCache: {
        type: 'remote',
        remotePath: 'https://raw.githubusercontent.com/wppconnect-team/wa-version/main/html/2.2412.54.html'
      }
    });

    this.setupEventHandlers();
    this.client.initialize();
  }

  setupEventHandlers() {
    this.client.on('qr', (qr) => {
      console.log('üì± QR Code recebido!');
      qrcode.generate(qr, { small: true });
      
      if (this.onQRCode) {
        this.onQRCode(qr);
      }
    });

    this.client.on('ready', () => {
      console.log('‚úÖ WhatsApp conectado com sucesso!');
      this.isConnected = true;
      
      if (this.onReady) {
        this.onReady();
      }
    });

    this.client.on('authenticated', () => {
      console.log('üîê WhatsApp autenticado!');
    });

    this.client.on('auth_failure', (msg) => {
      console.error('‚ùå Falha na autentica√ß√£o:', msg);
      this.isConnected = false;
    });

    this.client.on('disconnected', (reason) => {
      console.log('üîå WhatsApp desconectado:', reason);
      this.isConnected = false;
    });

    this.client.on('message', async (message) => {
      await this.handleIncomingMessage(message);
      
      if (this.onMessage) {
        this.onMessage(message);
      }
    });
  }

  async handleIncomingMessage(message) {
    try {
      const userPhone = message.from;
      const userMessage = message.body.trim();
      
      // Ignorar mensagens de grupo e status
      if (message.isGroupMsg || message.isStatus) {
        return;
      }

      console.log(`üì® Mensagem de ${userPhone}: ${userMessage}`);

      // Salvar mensagem no banco
      await saveMessage(userPhone, userMessage, 'user');

      // Obter estado atual do usu√°rio
      const currentState = this.userStates.get(userPhone) || 'menu';
      const userInfo = this.userData.get(userPhone) || {};

      // Processar de acordo com o estado
      switch(currentState) {
        case 'menu':
          await this.handleMenu(userPhone, userMessage, message, userInfo);
          break;
        case 'awaiting_budget_option':
          await this.handleBudgetOption(userPhone, userMessage, message, userInfo);
          break;
        case 'awaiting_template_selection':
          await this.handleTemplateSelection(userPhone, userMessage, message, userInfo);
          break;
        case 'awaiting_payment_decision':
          await this.handlePaymentDecision(userPhone, userMessage, message, userInfo);
          break;
        case 'awaiting_schedule_selection':
          await this.handleScheduleSelection(userPhone, userMessage, message, userInfo);
          break;
        default:
          await this.handleMenu(userPhone, userMessage, message, userInfo);
      }

    } catch (error) {
      console.error('‚ùå Erro ao processar mensagem:', error);
      await this.sendMessage(message.from, '‚ùå Ocorreu um erro. Tente novamente.');
    }
  }

  async handleMenu(userPhone, userMessage, message, userInfo) {
    const contact = await message.getContact();
    const contactName = contact.name || contact.pushname || 'Cliente';
    
    userInfo.name = contactName;
    this.userData.set(userPhone, userInfo);

    const lowerMessage = userMessage.toLowerCase();

    if (lowerMessage.includes('or√ßamento') || lowerMessage.includes('orcamento') || lowerMessage.includes('desejo um or√ßamento personalizado')) {
      const response = `Ol√° ${contactName}, agrade√ßo por voc√™ ter entrado em contato conosco üòä. Para o nosso or√ßamento voc√™ deve escolher uma das op√ß√µes abaixo:`;
      
      await this.sendMessage(userPhone, response);
      
      const optionsMessage = `üíé *ESCOLHA UMA OP√á√ÉO:*\n\n` +
        `üé® *1. ESCOLHER UM MODELO DE SITE*\n` +
        `üë®‚Äçüíº *2. FALAR COM ATENDIMENTO HUMANO*\n` +
        `üí¨ *3. DESCREVER MEU PROJETO*`;
      
      await this.sendMessage(userPhone, optionsMessage);
      this.userStates.set(userPhone, 'awaiting_budget_option');
      
    } else if (lowerMessage === '1' || lowerMessage.includes('template') || lowerMessage.includes('modelo')) {
      await this.showTemplatesCatalog(userPhone);
      
    } else if (lowerMessage === '2' || lowerMessage.includes('atendimento') || lowerMessage.includes('humano')) {
      await this.showScheduleOptions(userPhone);
      
    } else if (lowerMessage === '3' || lowerMessage.includes('projeto')) {
      await this.sendMessage(userPhone, 'üìù Por favor, descreva brevemente seu projeto que entraremos em contato para um or√ßamento personalizado!');
      this.userStates.set(userPhone, 'menu');
      
    } else if (lowerMessage.includes('ola') || lowerMessage.includes('ol√°') || lowerMessage === 'oi') {
      const welcomeMessage = `üëã Ol√° ${contactName}! Seja bem-vindo(a)! üòä\n\n` +
        `Sou seu assistente virtual e posso ajudar voc√™ com:\n\n` +
        `üé® *Or√ßamento de sites e templates*\n` +
        `üìÖ *Agendamento de atendimento*\n` +
        `üí¨ *Tirar d√∫vidas sobre nossos servi√ßos*\n\n` +
        `Digite *"or√ßamento"* para come√ßarmos!`;
      
      await this.sendMessage(userPhone, welcomeMessage);
      
    } else {
      // Resposta inteligente com Gemini
      const aiResponse = await generateResponse(userMessage, contactName);
      await this.sendMessage(userPhone, aiResponse);
    }
  }

  async handleBudgetOption(userPhone, userMessage, message, userInfo) {
    const lowerMessage = userMessage.toLowerCase();

    if (lowerMessage.includes('1') || lowerMessage.includes('escolher') || lowerMessage.includes('modelo')) {
      await this.sendMessage(userPhone, 'Entendi! Olhe a lista abaixo e escolha uma das op√ß√µes:');
      await this.showTemplatesCatalog(userPhone);
      
    } else if (lowerMessage.includes('2') || lowerMessage.includes('atendimento') || lowerMessage.includes('humano')) {
      await this.showScheduleOptions(userPhone);
      
    } else if (lowerMessage.includes('3') || lowerMessage.includes('projeto') || lowerMessage.includes('descrever')) {
      await this.sendMessage(userPhone, 'üìù Perfeito! Por favor, descreva brevemente seu projeto:\n\n‚Ä¢ Tipo de site necess√°rio\n‚Ä¢ Funcionalidades desejadas\n‚Ä¢ Prazo estimado\n\nEnviaremos um or√ßamento personalizado! üöÄ');
      this.userStates.set(userPhone, 'menu');
      
    } else {
      await this.sendMessage(userPhone, '‚ùå Por favor, escolha uma op√ß√£o v√°lida:\n\n1 - Escolher modelo de site\n2 - Atendimento humano\n3 - Descrever meu projeto');
    }
  }

  async showTemplatesCatalog(userPhone) {
    const templates = this.getTemplates();
    let catalogMessage = `üé® *CAT√ÅLOGO DE TEMPLATES* - ${templates.length} modelos dispon√≠veis\n\n`;
    
    // Mostrar primeiros 8 templates
    templates.slice(0, 8).forEach(template => {
      catalogMessage += `*${template.id}.* üè∑Ô∏è ${template.name}\n`;
      catalogMessage += `   üíµ R$ ${template.price} | üì¶ ${template.delivery}\n`;
      catalogMessage += `   üìù ${template.description.substring(0, 60)}...\n`;
      catalogMessage += `   üè∑Ô∏è ${template.category} | ‚≠ê ${template.features.slice(0, 2).join(', ')}\n\n`;
    });
    
    catalogMessage += `üìã *INSTRU√á√ïES:*\n`;
    catalogMessage += `Digite o *N√öMERO* do template que gostou para ver detalhes\n`;
    catalogMessage += `Ou digite *voltar* para o menu principal`;
    
    await this.sendMessage(userPhone, catalogMessage);
    this.userStates.set(userPhone, 'awaiting_template_selection');
  }

  async handleTemplateSelection(userPhone, userMessage, message, userInfo) {
    if (userMessage.toLowerCase() === 'voltar' || userMessage === '0') {
      await this.sendMessage(userPhone, 'Voltando ao menu principal...');
      this.userStates.set(userPhone, 'menu');
      return;
    }

    const templateNumber = parseInt(userMessage);
    const template = this.getTemplates().find(t => t.id === templateNumber);

    if (template) {
      userInfo.selectedTemplate = template;
      this.userData.set(userPhone, userInfo);
      
      const templateDetails = `üéØ *${template.name} - DETALHES COMPLETOS*\n\n` +
        `üìù ${template.description}\n\n` +
        `üí∞ *Investimento:* R$ ${template.price}\n` +
        `üì¶ *Entrega:* ${template.delivery}\n` +
        `üè∑Ô∏è *Categoria:* ${template.category}\n\n` +
        `‚≠ê *INCLUI:*\n${template.features.map(f => `‚úÖ ${f}`).join('\n')}\n\n` +
        `üíé *PR√ìXIMOS PASSOS:*\n` +
        `1Ô∏è‚É£ - *PAGAR AGORA* e iniciar projeto imediatamente\n` +
        `2Ô∏è‚É£ - *AGENDAR ATENDIMENTO* para tirar d√∫vidas\n` +
        `3Ô∏è‚É£ - *VER MAIS TEMPLATES*\n` +
        `4Ô∏è‚É£ - *VOLTAR* ao menu principal`;
      
      await this.sendMessage(userPhone, templateDetails);
      this.userStates.set(userPhone, 'awaiting_payment_decision');
      
    } else {
      await this.sendMessage(userPhone, '‚ùå Template n√£o encontrado. Digite o n√∫mero correto ou *voltar* para o menu.');
    }
  }

  async handlePaymentDecision(userPhone, userMessage, message, userInfo) {
    const template = userInfo.selectedTemplate;
    const lowerMessage = userMessage.toLowerCase();
    
    if (lowerMessage.includes('1') || lowerMessage.includes('pagar') || lowerMessage.includes('comprar')) {
      const pixMessage = `üíé *PAGAMENTO VIA PIX* üíé\n\n` +
        `üõí *Produto:* ${template.name}\n` +
        `üíµ *Valor:* R$ ${template.price}\n\n` +
        `üì± *CHAVE PIX (CPF/CNPJ):*\n` +
        `16997454758\n\n` +
        `üè¢ *Benefici√°rio:* Vitor\n` +
        `üí¨ *Identifica√ß√£o:* Template ${template.id} - ${template.name}\n\n` +
        `‚ö†Ô∏è *INSTRU√á√ïES:*\n` +
        `1. Realize o pagamento via PIX para a chave acima\n` +
        `2. Envie o comprovante para confirmarmos\n` +
        `3. Iniciaremos seu projeto imediatamente!\n\n` +
        `üöÄ *Ap√≥s o pagamento, seu site estar√° pronto em ${template.delivery}!*`;
      
      await this.sendMessage(userPhone, pixMessage);
      this.userStates.set(userPhone, 'menu');
      
    } else if (lowerMessage.includes('2') || lowerMessage.includes('agendar') || lowerMessage.includes('atendimento')) {
      await this.showScheduleOptions(userPhone);
      
    } else if (lowerMessage.includes('3') || lowerMessage.includes('mais') || lowerMessage.includes('templates')) {
      await this.showTemplatesCatalog(userPhone);
      
    } else if (lowerMessage.includes('4') || lowerMessage.includes('voltar')) {
      await this.sendMessage(userPhone, 'Voltando ao menu principal...');
      this.userStates.set(userPhone, 'menu');
      
    } else {
      await this.sendMessage(userPhone, '‚ùå Por favor, escolha uma op√ß√£o v√°lida (1, 2, 3 ou 4).');
    }
  }

  async showScheduleOptions(userPhone) {
    const availableSlots = this.getAvailableSlots();
    let scheduleMessage = `üìÖ *AGENDAMENTO DE ATENDIMENTO*\n\n` +
      `Escolha um hor√°rio dispon√≠vel para nosso atendimento:\n\n`;
    
    availableSlots.forEach((slot, index) => {
      scheduleMessage += `${index + 1}. üïê ${slot}\n`;
    });
    
    scheduleMessage += `\nüí° *INSTRU√á√ïES:*\n`;
    scheduleMessage += `Digite o *N√öMERO* do hor√°rio desejado\n`;
    scheduleMessage += `Ou digite *voltar* para o menu principal`;
    
    await this.sendMessage(userPhone, scheduleMessage);
    this.userStates.set(userPhone, 'awaiting_schedule_selection');
  }

  async handleScheduleSelection(userPhone, userMessage, message, userInfo) {
    if (userMessage.toLowerCase() === 'voltar' || userMessage === '0') {
      await this.sendMessage(userPhone, 'Voltando ao menu principal...');
      this.userStates.set(userPhone, 'menu');
      return;
    }

    const slotNumber = parseInt(userMessage);
    const availableSlots = this.getAvailableSlots();
    const selectedSlot = availableSlots[slotNumber - 1];

    if (selectedSlot) {
      const contact = await this.client.getContactById(userPhone);
      const contactName = contact.name || contact.pushname || 'Cliente';
      
      // Salvar agendamento no banco
      const scheduleDate = new Date();
      scheduleDate.setHours(parseInt(selectedSlot), 0, 0, 0);
      
      await saveSchedule(userPhone, contactName, scheduleDate, selectedSlot);
      
      const confirmationMessage = `‚úÖ *AGENDAMENTO CONFIRMADO!*\n\n` +
        `üë§ *Cliente:* ${contactName}\n` +
        `üìÖ *Data:* ${scheduleDate.toLocaleDateString('pt-BR')}\n` +
        `‚è∞ *Hor√°rio:* ${selectedSlot}\n\n` +
        `üí° *INFORMA√á√ïES IMPORTANTES:*\n` +
        `‚Ä¢ Estaremos dispon√≠veis no WhatsApp no hor√°rio agendado\n` +
        `‚Ä¢ Voc√™ receber√° uma lembran√ßa 1 hora antes\n` +
        `‚Ä¢ Para reagendar ou cancelar, entre em contato\n\n` +
        `Obrigado por confiar em nosso trabalho! üöÄ`;
      
      await this.sendMessage(userPhone, confirmationMessage);
      this.userStates.set(userPhone, 'menu');
      
    } else {
      await this.sendMessage(userPhone, '‚ùå Hor√°rio inv√°lido. Escolha um n√∫mero da lista ou digite *voltar*.');
    }
  }

  async sendMessage(phone, message) {
    try {
      if (!this.isConnected) {
        console.error('‚ùå WhatsApp n√£o est√° conectado');
        return false;
      }

      const sentMessage = await this.client.sendMessage(phone, message);
      await saveMessage(phone, message, 'bot');
      
      console.log(`‚úÖ Mensagem enviada para ${phone}`);
      return true;
    } catch (error) {
      console.error('‚ùå Erro ao enviar mensagem:', error);
      return false;
    }
  }

  getTemplates() {
    // Templates em mem√≥ria - pode ser substitu√≠do por banco de dados
    return [
      {
        id: 1,
        name: "Site Institucional Premium",
        description: "Site profissional completo com 5 p√°ginas, design responsivo e SEO otimizado",
        price: "497.00",
        category: "Institucional",
        features: ["5 p√°ginas", "Design responsivo", "Formul√°rio de contato", "SEO b√°sico"],
        delivery: "3-5 dias"
      },
      // ... outros templates
    ];
  }

  getAvailableSlots() {
    // Hor√°rios dispon√≠veis (13h √†s 23h)
    const slots = [];
    for (let hour = 13; hour <= 23; hour++) {
      slots.push(`${hour}:00`);
    }
    return slots;
  }

  getConnectionStatus() {
    return {
      isConnected: this.isConnected,
      user: this.client?.info?.wid?.user || null
    };
  }

  getStatistics() {
    return {
      activeUsers: this.userStates.size,
      userStates: Object.fromEntries(this.userStates),
      userData: Object.fromEntries(this.userData)
    };
  }
}

export default new WhatsAppService();
